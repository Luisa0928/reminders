<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/remindService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/remindService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const {
    statusActual,
    saveReminder,
    getReminders,
    deleteReminders } = require("../models/remindModels.js")

const { overdueStatus } = require("../utils/remindUtils.js")

var reminderDeleted = {}

function setTitle(title) {
    reminderDeleted[title] = title
}

//Esta funcion imprime el titulo del recordatorio cuando comprueba que es el momento indicado, de lo contrario espera un segundo para volverse 
//a ejecutar
 
function isItTimeToSendTheReminder(year, month, day, hour, minute, sendMessage) {
    var date = new Date()
    if (overdueStatus(year, month, day, hour, minute) == 0) {
        sendMessage()
    }
    else {
        setTimeout(function () { isItTimeToSendTheReminder(year, month, day, hour, minute, sendMessage) }, 1000)
        if (overdueStatus(year, month, day, hour, minute) == 1) {
            console.log("Recordatorio vencido")
        }
        if (overdueStatus(year, month, day, hour, minute) == -1) {
            console.log("Recordatorio pendiente.Faltan " + (minute - date.getMinutes()) + " minutos")
        }
    }

}
/**
 * Sets the promise that will show the message received by param
 * when the time, also given as a param, is met
 * @param {number} hour 
 * @param {number} minute 
 * @param {number} seg 
 * @param {string} message 
 */

// Esta funcion enviará en el futuro un recordatorio y lo eliminará de la lista, si ya está vencido o fue invalidado por el usuario
function secretary(year, month, day, hour, minute, tittle) {
    const myPromise = new Promise(function (resolve, reject) {
        isItTimeToSendTheReminder(year, month, day, hour, minute, function () {
            resolve(tittle)
        })
    })
    myPromise.then(function (reminderMessage) {
        if (reminderDeleted[tittle] == undefined) {
            statusActual(tittle)
            console.log(reminderMessage)
        } 
    })
}

// Esta funcion pone el status del recordatorio en la base de datos segun su momento en el tiempo
function updateStatus() {
    getReminders(function (reminderslist) {
        if (reminderslist != undefined) {
            var titleList = Object.keys(reminderslist)
            var i = 0
            while (i &lt; titleList.length) {
                var id = reminderslist[titleList[i]]
                var status = id.estado
                if (status == true) {
                    if (overdueStatus(id.year, id.month, id.day, id.hour, id.minute) == 0) {
                        setTimeout(function () { statusActual(id.tittle) }, 1000)
                    }
                    if (overdueStatus(id.year, id.month, id.day, id.hour, id.minute) == 1) {
                        statusActual(id.tittle)
                    }
                }
                i += 1
            }
        }

    })
}
//Invoca el metodo que carga las alarmas
updateStatus()

//Devuelve todas las alarmas
function getReminderService(callback) {
    getReminders(function (data) {
        callback(data)
    })
}


//Crea alarmas
function createReminderService(year, month, day, hour, minute, tittle) {
    secretary(year, month, day, hour, minute, tittle)
    saveReminder(year, month, day, hour, minute, tittle)
    return "El recordatorio ha sido creado"
}

//Elimina alarmas
function deleteReminderService(tittle) {
    setTitle(tittle)
    deleteReminders(tittle)
    return "El recordatorio ha sido eliminado"
}

module.exports = {
    getReminderService,
    createReminderService,
    deleteReminderService,
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controller.html">controller</a></li><li><a href="module-routes.html">routes</a></li></ul><h3>Global</h3><ul><li><a href="global.html#secretary">secretary</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Sat Jul 16 2022 18:23:04 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
